<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Payloads | Blockcore Documentation</title>
    <meta name="generator" content="VuePress 1.5.1">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#51b13e">
    <link rel="stylesheet" href="/styles/variables.css">
    <meta name="description" content="Blockcore Official Documentation">
    <meta name="msapplication-TileColor" content="#0f3b21">
    <meta name="theme-color" content="#ffffff">
    <link rel="preload" href="/assets/css/0.styles.6e9a4710.css" as="style"><link rel="preload" href="/assets/js/app.f0d64147.js" as="script"><link rel="preload" href="/assets/js/3.26f3d11e.js" as="script"><link rel="preload" href="/assets/js/6.e8f6683d.js" as="script"><link rel="prefetch" href="/assets/js/10.99fcd1b5.js"><link rel="prefetch" href="/assets/js/11.ce1f063c.js"><link rel="prefetch" href="/assets/js/12.c99197b6.js"><link rel="prefetch" href="/assets/js/13.c4e03edb.js"><link rel="prefetch" href="/assets/js/14.0be8db0a.js"><link rel="prefetch" href="/assets/js/15.c9a4284e.js"><link rel="prefetch" href="/assets/js/16.6b47e2aa.js"><link rel="prefetch" href="/assets/js/17.512ef3d7.js"><link rel="prefetch" href="/assets/js/18.835be0ad.js"><link rel="prefetch" href="/assets/js/19.4b3740e1.js"><link rel="prefetch" href="/assets/js/20.57ef98eb.js"><link rel="prefetch" href="/assets/js/21.3d530748.js"><link rel="prefetch" href="/assets/js/22.17d43d23.js"><link rel="prefetch" href="/assets/js/23.aa9e5890.js"><link rel="prefetch" href="/assets/js/24.e2bd7d0c.js"><link rel="prefetch" href="/assets/js/25.ff0699dc.js"><link rel="prefetch" href="/assets/js/26.e0430710.js"><link rel="prefetch" href="/assets/js/27.0be36ad0.js"><link rel="prefetch" href="/assets/js/28.3a2760ae.js"><link rel="prefetch" href="/assets/js/29.698fa4b0.js"><link rel="prefetch" href="/assets/js/30.8da640a7.js"><link rel="prefetch" href="/assets/js/31.6b266bf7.js"><link rel="prefetch" href="/assets/js/32.180ce65e.js"><link rel="prefetch" href="/assets/js/33.222ac523.js"><link rel="prefetch" href="/assets/js/34.a8cad795.js"><link rel="prefetch" href="/assets/js/35.c1b7c482.js"><link rel="prefetch" href="/assets/js/36.2184e160.js"><link rel="prefetch" href="/assets/js/37.cf2f758a.js"><link rel="prefetch" href="/assets/js/38.5d296541.js"><link rel="prefetch" href="/assets/js/39.3ad1249e.js"><link rel="prefetch" href="/assets/js/4.3703d2c9.js"><link rel="prefetch" href="/assets/js/40.3733f480.js"><link rel="prefetch" href="/assets/js/41.cbfc8dfe.js"><link rel="prefetch" href="/assets/js/42.b15001ac.js"><link rel="prefetch" href="/assets/js/43.c823c9cb.js"><link rel="prefetch" href="/assets/js/44.2d22b953.js"><link rel="prefetch" href="/assets/js/45.9f755fb4.js"><link rel="prefetch" href="/assets/js/46.99a896a7.js"><link rel="prefetch" href="/assets/js/5.65c8cdcf.js"><link rel="prefetch" href="/assets/js/7.85832266.js"><link rel="prefetch" href="/assets/js/8.7d869c6d.js"><link rel="prefetch" href="/assets/js/9.73e979cc.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.a4031134.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6e9a4710.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/blockcore.svg" alt="Blockcore Documentation" class="logo"> <span class="site-name can-hide">Blockcore Documentation</span></a> <div class="links"><form id="search-form" role="search" class="algolia-search-wrapper search-box"><input id="algolia-search-input" class="search-query"></form> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.blockcore.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://discord.gg/xa5BxWr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/block-core/" target="_blank" rel="noopener noreferrer github" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/block-core/documentation" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.blockcore.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Website
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://discord.gg/xa5BxWr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Chat
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/block-core/" target="_blank" rel="noopener noreferrer github" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/block-core/documentation" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/" aria-current="page" class="sidebar-link">Introduction</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Platform</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Overview/" class="sidebar-link">Overview</a></li><li><a href="/UseCases/" class="sidebar-link">Use Cases</a></li><li><a href="/ReferenceNodes/" class="sidebar-link">Reference Nodes</a></li><li><a href="/Walkthrough/" class="sidebar-link">Walkthrough</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Features" class="sidebar-heading clickable"><span>Features</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/NodeApi" class="sidebar-heading clickable"><span>API</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/PeerToPeer" class="sidebar-heading clickable open"><span>P2P</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Payloads/" aria-current="page" class="active sidebar-link">Payloads</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Support and Community</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/FAQ" class="sidebar-heading clickable open"><span>FAQ and common issues</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/FAQ/FAQ-General/" class="sidebar-link">General FAQ</a></li><li><a href="/FAQ/FAQ-Deployment/" class="sidebar-link">Deployment FAQ</a></li><li><a href="/FAQ/FAQ-Synchronization/" class="sidebar-link">Synchronization FAQ</a></li><li><a href="/FAQ/FAQ-Integrations/" class="sidebar-link">Integrations FAQ</a></li><li><a href="/FAQ/FAQ-Wallet/" class="sidebar-link">Wallet FAQ</a></li></ul></section></li><li><a href="/Support/" class="sidebar-link">Support</a></li><li><a href="/Contribute/" class="sidebar-link">Contribute</a></li><li><a href="/Community/" class="sidebar-link">Community</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Development</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Development/" class="sidebar-link">Development</a></li><li><a href="/SecurityIssues/" class="sidebar-link">Security Issues</a></li><li><a href="/SigningCommits/" class="sidebar-link">Signing Commits</a></li><li><a href="/Architecture/" class="sidebar-link">Architecture</a></li><li><a href="https://btc.indexer.blockcore.net/docs/index.html" target="_blank" rel="noopener noreferrer" class="sidebar-link">Blockcore Indexer API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="payloads"><a href="#payloads" class="header-anchor">#</a> Payloads</h1> <h2 id="standard-payloads"><a href="#standard-payloads" class="header-anchor">#</a> Standard payloads</h2> <p>Built into the Blockcore foundation there are some payloads used to handle the peer to peer protocol and connections of nodes, and exchange of blockchain data.</p> <p>Here are the built in primary payload types with their command names in parentheses:</p> <ul><li>AddrPayload (&quot;addr&quot;)</li> <li>BlockPayload (&quot;block&quot;)</li> <li>GetAddrPayload (&quot;getaddr&quot;)</li> <li>GetBlocksPayload (&quot;getblocks&quot;)</li> <li>GetDataPayload (&quot;getdata&quot;)</li> <li>GetHeadersPayload (&quot;getheaders&quot;)</li> <li>GetProvenHeadersPayload (&quot;getprovhdr&quot;)</li> <li>HaveWitnessPayload (&quot;havewitness&quot;)</li> <li>HeadersPayload (&quot;headers&quot;)</li> <li>InvPayload (&quot;inv&quot;)</li> <li>MempoolPayload (&quot;mempool&quot;)</li> <li>NotFoundPayload</li> <li>PingPayload (&quot;ping&quot;)</li> <li>PongPayload (&quot;pong&quot;)</li> <li>ProvenHeadersPayload (&quot;provhdr&quot;)</li> <li>RejectPayload (&quot;reject&quot;)</li> <li>SendHeadersPayload (&quot;sendheaders&quot;)</li> <li>TxPayload (&quot;tx&quot;)</li> <li>UnknowPayload</li> <li>VerAckPayload (&quot;verack&quot;)</li> <li>VersionPayload (&quot;version&quot;)</li></ul> <p>Here are payload types defined in features:</p> <ul><li>FeeFilterPayload (&quot;feefilter&quot;)</li> <li>PoAHeaderPayload (&quot;poahdr&quot;)</li> <li>StoragePayload (&quot;storage&quot;)</li> <li>StorageInvPayload (&quot;storageinv&quot;)</li></ul> <p>Here is a code map of the payload in the Blockcore assembly:</p> <figure><img src="/assets/img/PayloadCodeMap.51ef8c0a.png" alt=""></figure> <p>Here is a code map of the custom payload types defined in features:</p> <figure><img src="/assets/img/PayloadFeaturesCodeMap.e0e898e0.png" alt=""></figure> <h2 id="your-own-custom-payload"><a href="#your-own-custom-payload" class="header-anchor">#</a> Your own custom payload</h2> <p>You can implement your own custom payloads, which is a great way to build a communication solution between nodes connected in a peer to peer fashion.</p> <p>You can use these custom features to build chat solutions, data transfer solutions or any other logic that can be useful for a network of nodes.</p> <p>All you need is one or multiple payload types and an behavior class.</p> <p>Example of a payload. You should define these classes inside your own custom feature.</p> <div class="language-C# extra-class"><pre class="language-text"><code>// This sample is copied from the &quot;ping&quot; payload.
using NBitcoin;

namespace Blockcore.P2P.Protocol.Payloads
{
    [Payload(&quot;storage&quot;)]
    public class StoragePayload : Payload
    {
        private uint[] items;

        public uint[] Items { get { return this.items; } set { this.items = value; } }

        public StoragePayload(uint[] items)
        {
            this.items = items;
        }

        public override void ReadWriteCore(BitcoinStream stream)
        {
            stream.ReadWrite(ref this.items);
        }

        public override string ToString()
        {
            return base.ToString() + &quot; : &quot; + this.Items;
        }
    }
}
</code></pre></div><p>Then you also need a behavior that will process messages.</p> <div class="language-C# extra-class"><pre class="language-text"><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Blockcore.Connection;
using Blockcore.Interfaces;
using Blockcore.P2P.Peer;
using Blockcore.P2P.Protocol;
using Blockcore.P2P.Protocol.Behaviors;
using Blockcore.P2P.Protocol.Payloads;
using Blockcore.Signals;
using Blockcore.Utilities;
using Microsoft.Extensions.Logging;
using NBitcoin;

namespace Blockcore.Features.Storage
{
    /// &lt;summary&gt;
    /// Peer behavior for memory pool.
    /// Provides message handling of notifications from attached peer.
    /// &lt;/summary&gt;
    public class StorageBehavior : NetworkPeerBehavior
    {
        /// &lt;summary&gt;Connection manager for managing peer connections.&lt;/summary&gt;
        private readonly IConnectionManager connectionManager;

        /// &lt;summary&gt;Provider of IBD state.&lt;/summary&gt;
        private readonly IInitialBlockDownloadState initialBlockDownloadState;

        /// &lt;summary&gt;Instance logger for the memory pool behavior component.&lt;/summary&gt;
        private readonly ILogger logger;

        /// &lt;summary&gt;Factory used to create the logger for this component.&lt;/summary&gt;
        private readonly ILoggerFactory loggerFactory;

        /// &lt;summary&gt;The network that this component is running on.&lt;/summary&gt;
        private readonly Network network;

        /// &lt;summary&gt;
        /// Locking object for memory pool behaviour.
        /// &lt;/summary&gt;
        private readonly object lockObject;

        /// &lt;summary&gt;
        /// The min fee the peer asks to relay transactions.
        /// &lt;/summary&gt;
        public Money MinFeeFilter { get; set; }

        public StorageBehavior(
            IConnectionManager connectionManager,
            IInitialBlockDownloadState initialBlockDownloadState,
            ILoggerFactory loggerFactory,
            Network network)
        {
            this.connectionManager = connectionManager;
            this.initialBlockDownloadState = initialBlockDownloadState;
            this.logger = loggerFactory.CreateLogger(this.GetType().FullName);
            this.loggerFactory = loggerFactory;
            this.network = network;
            this.lockObject = new object();
        }

        /// &lt;inheritdoc /&gt;
        protected override void AttachCore()
        {
            this.AttachedPeer.MessageReceived.Register(this.OnMessageReceivedAsync);
        }

        /// &lt;inheritdoc /&gt;
        protected override void DetachCore()
        {
            this.AttachedPeer.MessageReceived.Unregister(this.OnMessageReceivedAsync);
        }

        /// &lt;inheritdoc /&gt;
        public override object Clone()
        {
            return new StorageBehavior(this.connectionManager, this.initialBlockDownloadState, this.loggerFactory, this.network);
        }

        private async Task OnMessageReceivedAsync(INetworkPeer peer, IncomingMessage message)
        {
            try
            {
                await this.ProcessMessageAsync(peer, message).ConfigureAwait(false);
            }
            catch (OperationCanceledException)
            {
                this.logger.LogTrace(&quot;(-)[CANCELED_EXCEPTION]&quot;);
                return;
            }
            catch (Exception ex)
            {
                this.logger.LogError(&quot;Exception occurred: {0}&quot;, ex.ToString());
                throw;
            }
        }

        private async Task ProcessMessageAsync(INetworkPeer peer, IncomingMessage message)
        {
            try
            {
                switch (message.Message.Payload)
                {
                    case StoragePayload storagePayload:
                        await this.ProcessStorageInPayloadAsync(peer, storagePayload).ConfigureAwait(false);
                        break;
                }
            }
            catch (OperationCanceledException)
            {
                this.logger.LogTrace(&quot;(-)[CANCELED_EXCEPTION]&quot;);
                return;
            }
        }

        private async Task ProcessStorageInPayloadAsync(INetworkPeer peer, StoragePayload message)
        {
            Guard.NotNull(peer, nameof(peer));

            if (peer != this.AttachedPeer)
            {
                this.logger.LogDebug(&quot;Attached peer '{0}' does not match the originating peer '{1}'.&quot;, this.AttachedPeer?.RemoteSocketEndpoint, peer.RemoteSocketEndpoint);
                this.logger.LogTrace(&quot;(-)[PEER_MISMATCH]&quot;);
                return;
            }

            List&lt;uint&gt; list = new List&lt;uint&gt;();
            list.Add(1);
            list.Add(2);
            list.Add(3);

            await this.SendStorageAsync(peer, list);
        }

        private async Task SendStorageAsync(INetworkPeer peer, List&lt;uint&gt; storageList)
        {
            var queue = new Queue&lt;uint&gt;(storageList);

            while (queue.Count &gt; 0)
            {
                uint[] items = queue.TakeAndRemove(5).ToArray();

                if (peer.IsConnected)
                {
                    this.logger.LogDebug(&quot;Sending items to peer '{0}'.&quot;, peer.RemoteSocketEndpoint);
                    await peer.SendMessageAsync(new StoragePayload(items)).ConfigureAwait(false);
                }
            }
        }

        public async Task SendTrickleAsync()
        {
            INetworkPeer peer = this.AttachedPeer;
            if (peer == null)
            {
                this.logger.LogTrace(&quot;(-)[NO_PEER]&quot;);
                return;
            }

            this.logger.LogDebug(&quot;Sending storage inventory to peer '{0}'.&quot;, peer.RemoteSocketEndpoint);
            try
            {
                // Sample data to send.
                List&lt;uint&gt; list = new List&lt;uint&gt;();
                list.Add(1);
                list.Add(2);

                await this.SendStorageAsync(peer, list).ConfigureAwait(false);
            }
            catch (OperationCanceledException)
            {
                this.logger.LogTrace(&quot;(-)[CANCELED_EXCEPTION]&quot;);
                return;
            }
        }
    }
}

</code></pre></div><p>Then finally you need your custom feature:</p> <div class="language-C# extra-class"><pre class="language-text"><code>using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Blockcore.AsyncWork;
using Blockcore.Builder;
using Blockcore.Builder.Feature;
using Blockcore.Configuration.Logging;
using Blockcore.Connection;
using Blockcore.Features.Storage.Persistence;
using Blockcore.P2P.Peer;
using Blockcore.P2P.Protocol.Payloads;
using Blockcore.Utilities;
using Microsoft.Extensions.DependencyInjection;

namespace Blockcore.Features.Storage
{
    public class StorageFeature : FullNodeFeature
    {
        /// &lt;summary&gt;The async loop we need to wait upon before we can shut down this manager.&lt;/summary&gt;
        private IAsyncLoop asyncLoop;

        /// &lt;summary&gt;Factory for creating background async loop tasks.&lt;/summary&gt;
        private readonly IAsyncProvider asyncProvider;

        /// &lt;summary&gt;
        /// Connection manager injected dependency.
        /// &lt;/summary&gt;
        private readonly IConnectionManager connection;

        /// &lt;summary&gt;Global application life cycle control - triggers when application shuts down.&lt;/summary&gt;
        private readonly INodeLifetime nodeLifetime;

        private readonly PayloadProvider payloadProvider;

        private readonly StorageBehavior storageBehavior;

        public StorageFeature(
            IConnectionManager connection,
            INodeLifetime nodeLifetime,
            IAsyncProvider asyncProvider,
            PayloadProvider payloadProvider,
            StorageBehavior storageBehavior)
        {
            this.connection = connection;
            this.nodeLifetime = nodeLifetime;
            this.payloadProvider = payloadProvider;
            this.asyncProvider = asyncProvider;
            this.storageBehavior = storageBehavior;
        }

        public override Task InitializeAsync()
        {
            // Register the behavior.
            this.connection.Parameters.TemplateBehaviors.Add(this.storageBehavior);

            // Register the payload types.
            this.payloadProvider.AddPayload(typeof(StoragePayload));

            // Make a worker that will filter connected knows that has announced our custom payload behavior.
            this.asyncLoop = this.asyncProvider.CreateAndRunAsyncLoop(&quot;Storage.SyncWorker&quot;, async token =&gt;
            {
                IReadOnlyNetworkPeerCollection peers = this.connection.ConnectedPeers;

                if (!peers.Any())
                {
                    return;
                }

                // Announce the blocks on each nodes behavior which supports relaying.
                IEnumerable&lt;StorageBehavior&gt; behaviors = peers.Where(x =&gt; x.PeerVersion?.Relay ?? false)
                                                              .Select(x =&gt; x.Behavior&lt;StorageBehavior&gt;())
                                                              .Where(x =&gt; x != null)
                                                              .ToList();

                foreach (StorageBehavior behavior in behaviors)
                {
                    await behavior.SendTrickleAsync().ConfigureAwait(false);
                }
            },
                this.nodeLifetime.ApplicationStopping,
                repeatEvery: TimeSpans.FiveSeconds,
                startAfter: TimeSpans.TenSeconds);

            return Task.CompletedTask;
        }
    }

    /// &lt;summary&gt;
    /// A class providing extension methods for &lt;see cref=&quot;IFullNodeBuilder&quot;/&gt;.
    /// &lt;/summary&gt;
    public static class FullNodeBuilderStorageExtension
    {
        public static IFullNodeBuilder UseStorage(this IFullNodeBuilder fullNodeBuilder)
        {
            LoggingConfiguration.RegisterFeatureNamespace&lt;StorageFeature&gt;(&quot;storage&quot;);

            fullNodeBuilder.ConfigureFeature(features =&gt;
            {
                features
                   .AddFeature&lt;StorageFeature&gt;()
                   .FeatureServices(services =&gt;
                   {
                       services.AddSingleton&lt;IDataStore, DataStore&gt;();
                       services.AddSingleton&lt;StorageBehavior&gt;();
                   });
            });

            return fullNodeBuilder;
        }
    }
}

</code></pre></div><p>This is basically all you need to start building custom data payload features ontop of your network of Blockcore nodes.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/block-core/documentation/edit/master/docs/Payloads.md" target="_blank" rel="noopener noreferrer">Edit this page</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/NodeApiAuthorization/" class="prev">
        Authorization
      </a></span> <span class="next"><a href="/FAQ/FAQ-General/">
        General FAQ
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0d64147.js" defer></script><script src="/assets/js/3.26f3d11e.js" defer></script><script src="/assets/js/6.e8f6683d.js" defer></script>
  </body>
</html>
